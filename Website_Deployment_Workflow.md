# Website Deployment Workflow

## Intro

This document describes the deployment of the IOOS documentation web pages generated with a [_**Hugo**_](http://gohugo.io/) static page generator. The _**Hugo**_ generator was picked out after some research and experiments mostly for the following reasons:
 * portability, i.e., it is a self-contained application that does not require installation; 
 * no prerequisite installation of a tool/language like Ruby, Python, or Java;
 * direct processing of the Markdown content;  
 * very satisfactory results with a bare minimal modification of the default themes and templates;
 * relatively simple workflow of the generated web site deployment onto GitHub Pages.

The following workflow description is mostly based on the [Hosting on GitHub Pages](http://gohugo.io/tutorials/github_pages_blog/) tutorial, which has been updated to reflect IOOS specifics.

## IOOS Documentation Repositories

The IOOS DMAC Documentation Strategy requires that all DMAC-related documentation is converted into Markdown, and stored in a specially structured GitHub repository. In general, the repository must contain a "doc" directory that holds all documents in Markdown, and a "README.md" file that briefly describes the repository:
```
   ioos/[some repository]/
    ├── doc/
    |    ├── DOC1.md
    |    ├── DOC2.md
    |    |    └── images/
    |    └── DOC3.md  
    └── README.md
```     
In some cases the repository may have more complex structure, and contain not only Markdown files; for example, the [sos-guidelines](https://github.com/ioos/sos-guidelines) repository includes an additional SOS Templates section with a set of XML files: 
```
   ioos/sos-guidelines/
    ├── doc/
    |    ├── testing/
    |    |    └── sos_test_list_github_notoc_summary.md
    |    └── wsdd/ 
    |         ├── sos_wsdd_github_notoc.md    
    |         └── sos_wsdd_github_toc.md
    ├── template/
    |    └── milestone 1.0/
    |          ├── OM-GetObservation.xml
    |          ├── SML-DescribeSensor-Network.xml
    |          ├── SML-DescribeSensor-Station.xml
    |          ├── SOS-GetCapabilities.xml
    |          ├── SWE-MultiStation-TimeSeries.xml
    |          ├── SWE-MultiStation-TimeSeries_QC.xml
    |          ├── SWE-SingleStation-SingleProperty-TimeSeries.xml
    |          ├── SWE-SingleStation-TimeSeriesProfile.xml
    |          └── SWE-SingleStation-TimeSeriesProfile_QC.xml
    └── README.md
```     

## Structure of IOOS Documentation Website

By default, _**Hugo**_ expects the content of the site to be structured in some specific way, and uses that same structure to render the website. 

The top level of a source directory will typically have the following elements:
```
   ioos/[some repository]/
    ├── archtypes/
    ├── content/
    ├── layouts/
    ├── static/
    └── config file
```     

The `content` directory by default holds the documents that are the actual content of the website, and sub-directories of the `content` directory form the sections. The real content holding directory may be changed in the _**Hugo**_ config file. 

The `static` directory is used to hold the common website elements, such as Style Sheets, Java Scripts, and images, etc., which will be copied directly into the final site when rendered. Although _**Hugo**_ does not require any specific structure for `static` directory, it is usually organized in the following way:
```
   static/
    ├── css/
    ├── js/
    └── images/
``` 

_**NOTES**_:
>1. Currently, _**Hugo**_ can render only Markdown files, so all documents in other formats have to be converted into Markdown for rendering; it is also necessary to put [summaries](#summary) of the documents on a website front page, and [sort](#front-matter) them in a specific order.
>2. If the original document directory is not defined as a 'contentdir' in the _**Hugo**_ config file, the content of that folder should be copied into the `contentdir'.
>3. The directory (folder) that contains images and figures for the original Markdown document must be copied/moved inside the _**static**_ directory for the proper website rendering.  The links to the images in the original document have to be modified accordingly.       


### Config File

The config file defines the framework of the website generated by _**Hugo**_. It defines site-wide settings (like the websites `baseurl`), and allows to modify to some extent the default website structure. For example, the `sos-guidelines` website has file `config.toml` with the following contents
```
baseurl = "http://ioos.github.io/sos-guidelines"
contentdir = "content"
layoutdir = "layouts"
publishdir = "public"
languageCode = "en-us"
Title = "SOS v1.0"
[params]
     Description = "Docs, codes, scripts, templates"
     Copyright = "(C) 2014 U.S. IOOS. Some rights reserved"
```
For detailed explanation of how to build the _**Hugo**_ config file, and the exact meaning of the parameters and operators refer to the [Configuration](http://gohugo.io/overview/configuration) section of _**Hugo**_ documentation.


### <a name="summary"></a> Html Templates

The IOOS project website is based on a _**Hugo**_ default theme called [Hyde](https://github.com/spf13/hyde). The default theme layout and templates were just slightly modified to add the IOOS logo to a sidebar, change the sidebar's color, and publish short documents' summary on the website home page.

_**NOTES**_

>1. The _**Hugo**_ requires that the home page should be defined as the 'index.html' file in the 'layouts' directory. 
>2. To show the document's summary on the website front page, the document has to start from the summary text separated from the rest of the document with the line that contains just `<!--more-->`
>3. The IOOS logo is in the 'ioos_blue2.png' file located in 'static/images/' directory.

For a detailed description of the _**Hugo**_ themes, templates and layouts refer to the [_**Hugo**_ documentation](http://gohugo.io/).

### <a name="front-matter"></a> Hugo Metadata in Content Files

To ensure a proper rendering of the website content, each document in the `contentdir` should include at the top a [metadata section](http://gohugo.io/content/front-matter/). This metadata section tells _**Hugo**_ some details of how to render the content file. For example, the following metadata section is included in the 'sos_test_list_github_notoc_summary.md' file:
```
+++
draft = false
title = "List of SOS Tests"
subtitle = "List of OGC CITE general & IOOS-specific tests for IOOS SOS Milestone 1.0"
type = "post"
date = 2014-08-04T08:10:23Z
weight = "2"
+++
```

For a detailed description of the metadata section supported formats and variables refer to the  _**Hugo**_ [Front Matter](http://gohugo.io/content/front-matter/) documentation.


#### Static & Dynamic Menu in Sidebar 

A default _**Hugo**_ template `sidebar.html' in the 'layouts/chrome/' directory was modified to allow some static menu items:  
```
<!-- sidebar menu start-->
    <ul class="sidebar-nav">
      <li><a href="http://ioos.github.io">IOOS Home</a> </li>
	  <li><a href="/sos-guidelines/">SOS Guidelines Home</a> </li>
      {{ range .Site.Menus.main }}
        <li><a href="{{.Url}}"> {{ .Name }} </a></li>
      {{end}}
    </ul>
<!-- sidebar menu end-->
```

The links to the GitHub IOOS main website home page and current documentation website home page were added to the sidebar to make these pages reachable from any page. If the content page Metadata section contains reference to the menu list item, _**Hugo**_ will place the link to that document page in the sidebar menu as well. For information on menus definition, refer to a [corresponding part](http://gohugo.io/extras/menus/) of _**Hugo**_ documentation. 


## Workflow for IOOS Documentation Website deployment on GitHub

GitHub Pages will serve up a website for any repository that has a branch called `gh-pages` with a valid `index.html` file at that branch's root. To keep an adequate separation between the `master` and `gh-pages` branches, and at the same time make a deployment process visual and simple, the developers of _**Hugo**_ suggested a workflow that is based on use of the `git subtree` family of commands. It allows to mirror the entire `public` directory (which contains the generated website) into the root of the `gh-pages` branch of the repository. As a result, all content modification can be done on the `master` branch, and after _**Hugo**_ has generated the site output into the `public` directory it can be pushed directly to the correct place for GitHub Pages to serve the website. Below is a step-by-step description of the workflow that is reproduced from the ["_Hosting on GitHub Pages_"](http://gohugo.io/tutorials/github_pages_blog/) _**Hugo**_ tutorial. 

_**NOTES**_:
>1. The workflow was developed for Linux. On Windows, some commands either have to be modified (e.g. `rm -rf` to `rmdir c:\test /s /q`), or Linux native commands can be used with the Linux [CoreUtils](http://gnuwin32.sourceforge.net/packages.html) installed.
>2. All `git` commands have to be run from the site `<root>` directory, i.e. the directory, where the `content` (or another directory defined as `contentdir`) and `layout` sub-directories are located). 
>2. The `[some-repository-name]` should be changed to the real repository GitHub address, e.g., `ioos/sos-guidelines`. 
>3. The following workflow is for initializing the website for the first time. For subsequent updates a modified workflow is needed.

```
    1. Create a new orphand branch (no commit history) named gh-pages
         git checkout --orphan gh-pages

    2. Unstage all files
        git rm --cached $(git ls-files)
        * works in some cases, in others deleting all files is required not just removing them from the index.

    3. Grab one file from the master branch so we can make a commit
        git checkout master README.md

    4. Add and commit that file
        git add README.md
        git commit -m "INIT: initial commit on gh-pages branch"

    5. Push to remote gh-pages branch 
        git push origin gh-pages

    6. Return to master branch
        git checkout master

    7. Remove the public folder to make room for the gh-pages subtree
        rm -rf public

    8. Add the gh-pages branch of the repository. It will look like a folder named public
        git subtree add --prefix public git@github.com:[some-repository-name].git gh-pages --squash

    9. Pull down the file we just committed. This helps avoid merge conflicts
        git subtree pull --prefix=public
        * This might work for some, for others the full command specifying the repo and reference is required:
                git subtree pull --prefix=public git@github.com:[some-repository-name].git gh-pages
        	

    10. Run Hugo. Generated site will be placed in public directory
         hugo

    11. Add everything
         git add -A

    12. Commit and push to master
         git commit -m "Updating site" 
         git push origin master
	* theoretically this should work, but in some circumstances, git barfs and refuses to do it. Follow git's instructions and your instincts.

     13. Push the public subtree to the gh-pages branch
          git subtree push --prefix=public git@github.com:[some-repository-name].git gh-pages
          * again, fine in theory, but refusal to cooperate has been encountered on occasion, requiring removal of public, re-running hugo, another pull from the remote, and other ad hoc measures. 
```


### Website Updates

After initial deployment, any update of the website would include steps 10 through 13 apart from the creation/update of the content and verification of the generated website. These 4 steps are the same every time content is added or modified. It would be much easier, if that repetitive process is automated with some sort of script. A couple of Linux Bash scripts was developed by Dana Woodman for the [Chimer Arta & Maker Space](https://github.com/chimera/chimeraarts.org) website to automate [preview](https://github.com/chimera/chimeraarts.org/blob/master/preview) and [publish](https://github.com/chimera/chimeraarts.org/blob/master/publish) processes. The latter script was then adopted by Spencer Lyon, and modified into [`deploy.sh`](https://github.com/spencerlyon2/hugo_gh_blog/blob/master/deploy.sh): 

**Deploy.sh:**

    #!/bin/bash
    # This script works most times. Difficulty has been encountered at others. YMMV, and test carefully before using blindly.

    echo -e "\033[0;32mDeploying updates to GitHub...\033[0m"

    # Build the project. 
    hugo
    
    # Add changes to git.
    git add -A

    # Commit changes.
    msg="rebuilding site `date`"
    if [ $# -eq 1 ]
      then msg="$1"
    fi
    git commit -m "$msg"

    # Push source and build repos.
    git push origin master
    git subtree push --prefix=public git@[some-repository-name].git gh-pages

The script allows to replace the last four items from the above workflow list with a single command `bash deploy.sh`. Similar to the workflow, the `[some-repository-name]` in the script's last line has to be replaced with the real repository GitHub address, e.g. `ioos/sos-guidelines`. 

